<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Function Call Graph Visualization (ECharts)</title>
    <style>
        html, body { height: 100%; }
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { height: 100vh; max-width: 100%; margin: 0 auto; background: white; border-radius: 0; box-shadow: 0 0 0 rgba(0,0,0,0); display: flex; flex-direction: column; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px 20px; text-align: left; }
        .header h1 { margin: 0; font-weight: 400; cursor: pointer; transition: all 0.3s ease; }
        .header h1:hover { transform: translateY(-2px); text-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        .header h1:active { transform: translateY(0); }
        .controls { padding: 12px 16px; background: #f8f9fa; border-bottom: 1px solid #e9ecef; display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        .control-group { display: flex; align-items: center; gap: 8px; }
        .control-group input { padding: 8px 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px; }
        .btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .visualization { flex: 1; min-height: 0; }
        #chart { width: 100%; height: 100%; background: #f8f9fa; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script>
        function goHome() { window.location.href = '/draw_call_graph'; }
        function drawNew() {
            const filepath = document.getElementById('filepath').value.trim();
            const functionName = document.getElementById('function').value.trim();
            const maxDepth = document.getElementById('max_depth').value.trim();
            if (!filepath) { alert('Please enter a file path'); return; }
            let url = '/draw_call_graph?filepath=' + encodeURIComponent(filepath);
            if (functionName) { url += '&function_name=' + encodeURIComponent(functionName); }
            if (maxDepth) { url += '&max_depth=' + encodeURIComponent(maxDepth); }
            window.location.href = url;
        }
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 onclick="goHome()" style="margin:0; font-weight:400;">🔗 Function Call Graph</h1>
            <p style="margin:4px 0 0; opacity:.9;">Interactive visualization of function call relationships (ECharts)</p>
        </div>
        <div class="controls">
            <div class="control-group">
                <label for="filepath">File:</label>
                <input id="filepath" type="text" value="__FILEPATH_INPUT__" placeholder="/mnt/repo/src/main.rs">
            </div>
            <div class="control-group">
                <label for="function">Function:</label>
                <input id="function" type="text" value="" placeholder="main (optional)" list="function_suggestions">
                <datalist id="function_suggestions"></datalist>
            </div>
            <div class="control-group">
                <label for="max_depth">Max Depth:</label>
                <input id="max_depth" type="number" min="1" max="5" value="2">
            </div>
            <button class="btn" onclick="drawNew()">Draw</button>
        </div>
        <div class="visualization">
            <div id="chart"></div>
        </div>
    </div>
    <script>
        const graphData = __GRAPH_JSON__;
        const chart = echarts.init(document.getElementById('chart'));
        const categories = [{ name: 'Function' }];
        const degree = {};
        graphData.links.forEach(l => { degree[l.source] = (degree[l.source] || 0) + 1; degree[l.target] = (degree[l.target] || 0) + 1; });
        const data = graphData.nodes.map(n => {
            const deg = degree[n.name] || 0;
            const size = Math.max(10, Math.min(48, 14 + deg * 2.5));
            return { id: n.name, name: n.name, value: deg, file_path: n.file_path, line_start: n.line_start, line_end: n.line_end, category: 0, symbolSize: size, label: { show: true }, draggable: true };
        });
        const links = graphData.links.map(e => ({ source: e.source, target: e.target }));
        (function setupFunctionSuggest() {
            const input = document.getElementById('function');
            const datalist = document.getElementById('function_suggestions');
            const uniqueNames = Array.from(new Set(graphData.nodes.map(n => n.name))).sort();
            function fuzzyScore(q, s) { q = q.toLowerCase(); s = s.toLowerCase(); let qi = 0, score = 0; for (let i = 0; i < s.length && qi < q.length; i++) { if (s[i] === q[qi]) { qi++; score += 2; } else if (q.includes(s[i])) { score += 1; } } return qi === q.length ? score : -1; }
            function updateList() { const q = input.value.trim(); let candidates = uniqueNames; if (q.length > 0) { candidates = uniqueNames.map(name => ({ name, score: fuzzyScore(q, name) })).filter(x => x.score >= 0).sort((a,b) => b.score - a.score).slice(0, 50).map(x => x.name); } else { candidates = uniqueNames.slice(0, 50); } datalist.innerHTML = candidates.map(n => `<option value="${n}"></option>`).join(''); }
            input.addEventListener('input', updateList);
            updateList();
        })();
        const option = { backgroundColor: '#ffffff', tooltip: {}, legend: [{ data: categories.map(c => c.name) }], animationDuration: 1200, animationEasingUpdate: 'quinticInOut', series: [{ name: 'Call Graph', type: 'graph', layout: 'force', roam: true, focusNodeAdjacency: true, categories: categories, data: data, links: links, edges: links, edgeSymbol: ['none', 'arrow'], edgeSymbolSize: 6, label: { show: true, position: 'right', formatter: function(p) { return p.data?.name || p.name; } }, lineStyle: { color: '#98a2b3', opacity: 0.85, curveness: 0.25, width: 1.5 }, emphasis: { focus: 'adjacency', lineStyle: { width: 8 } }, force: { repulsion: 520, edgeLength: [80, 220], gravity: 0.1 } }] };
        chart.setOption(option);

        // Edge highlight styles for clarity yet harmonious with theme
        const DEFAULT_EDGE = { color: '#98a2b3', width: 1.5, opacity: 0.85 };
        const OUTGOING_EDGE = { color: '#4f46e5', width: 3, opacity: 0.95 }; // calls →
        const INCOMING_EDGE = { color: '#f59e0b', width: 2.5, opacity: 0.95 }; // ← called by
        const DIMMED_EDGE = { color: '#cbd5e1', width: 1, opacity: 0.2 };

        // Keep a pristine copy of base links for resets
        const baseLinks = links.map(e => ({ ...e }));

        function applyEdgeStylesFor(nodeName) {
            const styledLinks = baseLinks.map(e => {
                if (e.source === nodeName) {
                    return { ...e, lineStyle: { ...OUTGOING_EDGE, curveness: 0.25 } };
                } else if (e.target === nodeName) {
                    return { ...e, lineStyle: { ...INCOMING_EDGE, curveness: 0.25 } };
                } else {
                    return { ...e, lineStyle: { ...DIMMED_EDGE, curveness: 0.25 } };
                }
            });
            chart.setOption({ series: [{
                links: styledLinks,
                edges: styledLinks,
                lineStyle: DEFAULT_EDGE
            }] });
        }

        function resetEdgeStyles() {
            chart.setOption({ series: [{
                links: baseLinks,
                edges: baseLinks,
                lineStyle: DEFAULT_EDGE
            }] });
        }

        // Highlight outgoing vs incoming when a node is selected
        chart.on('click', function(params) {
            if (params && params.dataType === 'node' && params.data && params.data.name) {
                applyEdgeStylesFor(params.data.name);
            } else {
                // Clicked on empty space or non-node → reset to default
                resetEdgeStyles();
            }
        });

        // Provide a quick way to reset via double-click anywhere
        chart.getZr().on('dblclick', function() { resetEdgeStyles(); });

        window.addEventListener('resize', () => chart.resize());
    </script>
</body>
</html> 